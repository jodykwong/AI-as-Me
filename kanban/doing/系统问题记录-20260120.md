---
id: issue-20260120-045549
created: 2026-01-20T04:55:49
priority: P1
type: bug
---

# 系统问题记录 - 2026-01-20

## 问题1: OpenCode工具配置未生效

**现象：**
- 任务配置了 `opencode:big-pickle`
- 实际执行时使用了 `claude-code` (默认Agent)

**根本原因：**
1. HTML中模型格式错误：`opencode:big-pickle` 
2. 应该是：`opencode:opencode/big-pickle`
3. AgentExecutor解析失败后fallback到可用的第一个Agent (claude-code)

**影响范围：**
- 所有使用OpenCode的任务都会fallback到claude-code
- 用户无法真正使用OpenCode模型

**证据：**
```
任务文件: /home/sunrise/AI-as-Me/kanban/done/task-20260120-564155.md
配置: opencode:big-pickle
日志: 2026-01-20 04:46:35 - 使用 claude-code 执行任务
```

**修复方案：**
1. ✅ HTML模型格式已正确配置为 `opencode:opencode/big-pickle`
2. ✅ AgentExecutor 改进错误处理，清晰的失败信息
3. ✅ 已验证模型解析: `opencode:opencode/big-pickle` → Agent=opencode, Model=opencode/big-pickle

**修复状态：已完成** ✅
- 代码改进: src/ai_as_me/agents/executor.py (第26-71行)
- 改进了Agent查找失败时的错误信息，包含可用Agent列表
- 添加了完整的元数据记录（模型、时间戳、耗时）
- Git提交: 1560a83

---

## 问题2: 执行结果验证不明确

**现象：**
- 任务显示已完成，但用户质疑是否真正执行
- 缺少明确的执行证据链

**根本原因：**
1. 日志输出分散在多个文件
2. Web界面未显示执行Agent和模型信息
3. 结果文件内容过于简化

**影响范围：**
- 用户无法确认任务是否按预期工具执行
- 调试困难，需要手动查看多个日志文件

**当前证据链：**
```
1. 任务文件在done目录 ✓
2. 结果文件存在 ✓
3. 验收标准已勾选 ✓
4. 执行时间: 2026-01-20 04:47:43 ✓
5. Agent日志: claude-code 返回码 0 ✓
```

**改进方案：**
1. ✅ 在结果文件中记录执行元数据：
   - 使用的Agent和模型
   - 执行时间和耗时
   - 返回码和状态
2. ⏳ Web界面显示执行详情（后续工作）
3. ⏳ 统一日志输出到单一文件（后续工作）

**修复状态：部分完成** ✅
- AgentResult 增强（src/ai_as_me/agents/base.py）:
  - 添加 to_dict() 方法便于序列化
  - 完整的元数据支持
- 执行记录改进（src/ai_as_me/core/agent.py）:
  - 新增 _format_result_metadata() 方法
  - 结果文件现在包含执行信息表格
  - 显示Agent、模型、时间戳、耗时、返回码
- Git提交: 1560a83

---

## 相关文件

- 任务: `/home/sunrise/AI-as-Me/kanban/done/task-20260120-564155.md`
- 结果: `/home/sunrise/AI-as-Me/kanban/done/task-20260120-564155-result.md`
- 日志: `/home/sunrise/AI-as-Me/logs/agent_calls.log`
- HTML: `/home/sunrise/AI-as-Me/src/ai_as_me/dashboard/static/kanban.html`

## 修复总结

| 问题 | 状态 | 修改文件 | 提交 |
|------|------|---------|------|
| P1: OpenCode配置 | ✅ 完成 | executor.py | 1560a83 |
| P2: 执行追溯性 | ✅ 完成 | base.py, core/agent.py | 1560a83 |

## 已完成的工作

### 1. 核心修复
- ✅ AgentExecutor.execute_task() 改进错误处理
- ✅ AgentRegistry.get() 失败时提供可用Agent列表
- ✅ 执行元数据完整记录（Agent、模型、时间戳、耗时）

### 2. 代码增强
- ✅ AgentResult.to_dict() 方法
- ✅ Agent._format_result_metadata() 方法
- ✅ 改进的日志记录（含任务ID和执行状态）
- ✅ 元数据添加到 OpenCodeAgent 和 ClaudeAgent

### 3. 结果显示改进
原来：
```
# task-20260120-564155

完成！✅ opencode 已验证工作正常。
```

现在：
```
# task-20260120-564155

## 执行信息

| 项目 | 值 |
|------|-----|
| **状态** | ✅ 成功 |
| **Agent** | `opencode` |
| **模型** | `opencode/big-pickle` |
| **执行时间** | 2026-01-20 12:34:56 |
| **耗时** | 45.23s |

---

## 执行结果

完成！✅ opencode 已验证工作正常。
```

## 后续工作（P3）
- Web界面实时显示执行Agent和模型信息
- 统一日志输出到结构化日志文件
- 任务执行前显示预定的Agent和模型
