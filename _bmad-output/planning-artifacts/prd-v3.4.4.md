# PRD v3.4.4 - Agent 模型自动化配置

## 1. 产品概述

### 1.1 背景
AI-as-Me 集成了 OpenCode 和 Claude Code 作为外部 Agent，但当前使用硬编码的模型名称，导致配置过期和维护困难。

### 1.2 目标
实现 Agent 模型的自动化检测和智能选择，降低维护成本，提升系统可靠性。

## 2. 功能需求

### 2.1 OpenCode 模型自动化

#### FR-1: 模型动态查询
- **描述**: 系统能够实时查询 OpenCode 支持的所有模型
- **输入**: 无
- **输出**: 模型列表 (JSON 格式)
- **优先级**: P0

#### FR-2: 免费模型检测
- **描述**: 从所有模型中筛选出免费可用的模型
- **输入**: 模型列表
- **输出**: 免费模型列表
- **优先级**: P0

#### FR-3: 首选模型选择
- **描述**: 自动选择第一个可用的免费模型作为默认配置
- **输入**: 免费模型列表
- **输出**: 首选模型名称
- **优先级**: P0

### 2.2 Claude Code 模型智能选择

#### FR-4: 模型别名查询
- **描述**: 查询 Claude Code 支持的模型别名
- **输入**: 无
- **输出**: 别名列表 (haiku, sonnet, opus)
- **优先级**: P0

#### FR-5: 任务复杂度分类
- **描述**: 根据任务描述自动判断复杂度
- **规则**:
  - 简单: < 50 词或 < 5 行
  - 常规: 50-200 词
  - 复杂: > 200 词或 > 20 行
- **优先级**: P0

#### FR-6: 智能模型选择
- **描述**: 根据任务复杂度自动选择合适的模型
- **映射**:
  - 简单 → haiku
  - 常规 → sonnet
  - 复杂 → opus
- **优先级**: P0

### 2.3 统一 Agent 管理

#### FR-7: 统一调用接口
- **描述**: 提供统一的 Agent 调用接口
- **输入**: 任务描述 + Agent 类型
- **输出**: 执行结果 + 使用的模型
- **优先级**: P1

#### FR-8: 配置持久化
- **描述**: 将检测到的模型写入配置文件
- **位置**: `.opencode/config.yaml`
- **优先级**: P1

## 3. 非功能需求

### 3.1 性能
- 模型查询响应时间 < 3 秒
- 任务分类处理时间 < 100ms

### 3.2 可靠性
- 模型检测成功率 > 99%
- 配置错误率 = 0

### 3.3 可维护性
- 代码模块化，单一职责
- 完整的错误处理
- 清晰的日志输出

### 3.4 可扩展性
- 支持新增 Provider
- 支持自定义选择策略

## 4. 用户故事

### US-1: 自动配置 OpenCode
**作为** 系统管理员  
**我想要** 系统自动检测并配置可用的免费模型  
**以便** 无需手动查找和更新模型名称

**验收标准**:
- 运行检测脚本后自动输出可用模型
- 配置文件自动更新为正确的模型名称
- 模型名称格式正确 (provider/model)

### US-2: 智能选择 Claude 模型
**作为** 开发者  
**我想要** 系统根据任务复杂度自动选择合适的模型  
**以便** 平衡成本和质量

**验收标准**:
- 简单任务使用 haiku (快速、低成本)
- 复杂任务使用 sonnet/opus (高质量)
- 选择逻辑可配置

### US-3: 统一管理多个 Agent
**作为** 开发者  
**我想要** 通过统一接口调用不同的 Agent  
**以便** 简化代码和维护

**验收标准**:
- 单一入口调用 OpenCode 和 Claude Code
- 返回格式统一
- 错误处理一致

## 5. 技术方案

### 5.1 核心脚本
- `query_opencode_models.py`: 查询 OpenCode 模型
- `detect_opencode_models.py`: 检测首选模型
- `query_claude_models.py`: 查询 Claude 别名
- `select_claude_model.py`: 智能选择模型
- `agent_manager.py`: 统一管理器

### 5.2 依赖
- Python 3.10+
- subprocess, json, requests
- npx, opencode-ai, claude-code

## 6. 里程碑

### M1: OpenCode 自动化 ✅
- 完成模型查询和检测
- 更新配置文件

### M2: Claude 智能选择 ✅
- 完成任务分类
- 实现模型选择

### M3: 统一管理 ✅
- 实现 Agent Manager
- 统一调用接口

### M4: 集成和优化 ⏳
- 集成到 CLI
- 添加日志和监控
- 实现 fallback 机制

## 7. 风险和缓解

### 风险 1: 模型 API 变更
- **影响**: 查询失败
- **缓解**: 添加 fallback 到默认配置

### 风险 2: 任务分类不准确
- **影响**: 选择不合适的模型
- **缓解**: 支持手动覆盖

### 风险 3: 网络问题
- **影响**: 无法查询模型
- **缓解**: 缓存上次成功的结果

## 8. 成功指标

- OpenCode 配置错误率 = 0
- Claude 模型选择准确率 > 90%
- Agent 调用成功率 > 95%
- 配置维护时间减少 80%
