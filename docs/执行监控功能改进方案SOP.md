# 执行监控功能改进方案 SOP

基于对您当前Kanban页面执行监控与BettaFish项目执行监控的对比分析，以下是改进方案的标准操作流程：

## 一、现状分析
### 当前执行监控的问题

- 状态展示单一：只显示"正在执行..."，无法体现任务进度
- 阶段不清晰：缺乏任务执行的分阶段进度展示
- 信息层级扁平：任务卡片信息堆叠，主次不分明
- 实时性体验差：5秒轮询刷新，无实时日志流
- 无执行步骤可视化：看不到Agent内部的执行步骤

## 二、改进目标
参照BettaFish的执行监控设计，实现：

- 分阶段进度可视化
- 实时日志流推送
- 执行步骤/节点展示
- 更丰富的状态标识
- 异常状态突出展示

## 三、改进方案SOP

### 阶段1：数据结构改造
#### 步骤1.1 扩展任务状态模型

- 新增 `current_phase` 字段：记录当前执行阶段（初始化/执行中/验证中/完成）
- 新增 `progress` 字段：进度百分比（0-100）
- 新增 `steps` 数组：记录执行步骤列表
- 新增 `logs` 数组：记录实时日志

#### 步骤1.2 定义执行阶段枚举

- **PREPARING**：准备中
- **ANALYZING**：分析任务需求
- **EXECUTING**：执行核心逻辑
- **VALIDATING**：验收校验
- **COMPLETED**：执行完成
- **FAILED**：执行失败

### 阶段2：后端API改造
#### 步骤2.1 实现SSE实时推送接口

- 创建 `/api/task/{task_id}/stream` 端点
- 使用Server-Sent Events推送实时日志
- 支持进度、阶段、日志三类事件类型

#### 步骤2.2 新增任务详情接口

- 创建 `/api/task/{task_id}/detail` 端点
- 返回完整的执行步骤历史
- 包含每个步骤的输入/输出/耗时

### 阶段3：前端UI重构
#### 步骤3.1 任务卡片改造

- 添加进度条组件（显示整体进度）
- 阶段指示器（显示当前所处阶段）
- 状态颜色编码：
  - 🟡 黄色：准备中
  - 🔵 蓝色：执行中
  - 🟢 绿色：已完成
  - 🔴 红色：失败

#### 步骤3.2 详情面板设计

- 左侧：步骤时间线（纵向展示执行节点）
- 右侧：实时日志区（可滚动、自动跟随）
- 底部：操作按钮（暂停/恢复/取消/重试）

#### 步骤3.3 执行时间线组件

- 每个步骤显示：图标 + 步骤名称 + 耗时
- 当前步骤高亮 + 动画效果
- 已完成步骤显示✓，失败步骤显示✗

### 阶段4：实时通信实现
#### 步骤4.1 前端SSE连接管理

- 任务开始执行时建立SSE连接
- 接收实时日志并追加到日志区
- 接收进度更新并刷新进度条
- 任务完成/失败时关闭连接

#### 步骤4.2 断线重连机制

- 连接断开时自动重试（指数退避）
- 重连后从断点续传日志

### 阶段5：用户体验优化
#### 步骤5.1 添加执行统计摘要

- 显示总步骤数 / 已完成步骤数
- 显示预估剩余时间
- 显示资源消耗（如Token用量）

#### 步骤5.2 错误处理优化

- 失败任务显示错误摘要
- 提供"重试"和"查看详情"入口
- 支持错误日志一键复制

#### 步骤5.3 声音/通知提醒

- 任务完成时浏览器通知
- 任务失败时提示音（可选）

## 四、实施优先级

| 优先级 | 改进项 | 工作量 |
|--------|--------|--------|
| P0 | 进度条 + 阶段指示器 | 小 |
| P0 | 状态颜色编码 | 小 |
| P1 | 执行步骤时间线 | 中 |
| P1 | SSE实时日志推送 | 中 |
| P2 | 详情面板完善 | 中 |
| P2 | 断线重连机制 | 小 |
| P3 | 执行统计摘要 | 小 |
| P3 | 通知提醒 | 小 |

## 五、验收标准

- ✅ 用户能看到任务当前处于哪个执行阶段
- ✅ 用户能看到实时滚动的执行日志
- ✅ 用户能看到整体进度百分比
- ✅ 任务失败时有明确的错误提示
- ✅ 页面刷新后能恢复之前的监控状态
- ✅ 多任务并行时各自独立显示状态

---

以上方案参考了BettaFish项目的ForumEngine监控机制和多Agent协作可视化设计，结合您当前Kanban页面的实际情况进行了适配。核心改进点是从"简单状态展示"升级为"分阶段进度+实时日志流+执行步骤时间线"的综合监控体验。
