# AI-as-Me v2.0 实施 Workflows

## Workflow 1: P1 - Agent CLI 集成 (0.5天)

### 任务清单
- [ ] 创建 `orchestrator/agent_cli.py` - Agent CLI 封装
- [ ] 实现 Agent 健康检查
- [ ] 支持 OpenCode HTTP API 模式
- [ ] 创建 `config/agent_profiles.json` 配置文件

### 实施步骤

#### Step 1.1: Agent CLI 封装
```python
# src/ai_as_me/orchestrator/agent_cli.py
class AgentCLI:
    def __init__(self, agent_type: str, profile: str = "DEFAULT")
    def execute(self, task: str, soul_prompt: str) -> ExecutionResult
    def health_check() -> bool
    def get_available_agents() -> List[str]
```

#### Step 1.2: Agent Profiles 配置
```json
// config/agent_profiles.json
{
  "CLAUDE_CODE": {
    "DEFAULT": {"dangerously_skip_permissions": true},
    "APPROVALS": {"approvals": true}
  },
  "OPENCODE": {
    "DEFAULT": {"auto_approve": true},
    "APPROVALS": {"auto_approve": false}
  }
}
```

#### Step 1.3: 健康检查
- 检查 npx 可用性
- 验证 Agent CLI 版本
- 测试基础调用

---

## Workflow 2: P2 - 任务调度器 (0.5天)

### 任务清单
- [ ] 创建 `orchestrator/scheduler.py` - 任务调度
- [ ] 实现任务类型识别
- [ ] Agent 选择策略
- [ ] 进程生命周期管理

### 实施步骤

#### Step 2.1: 任务调度器
```python
# src/ai_as_me/orchestrator/scheduler.py
class TaskScheduler:
    def __init__(self, kanban_db: KanbanDB)
    def get_next_task() -> Optional[Task]
    def select_agent(task: Task) -> str
    def execute_task(task: Task) -> ExecutionResult
```

#### Step 2.2: Agent 选择策略
```python
def select_agent(task: Task) -> str:
    """根据任务类型选择最适合的 Agent"""
    if "代码" in task.title or "code" in task.title.lower():
        return "CLAUDE_CODE"
    elif "中文" in task.description:
        return "QWEN_CODE"
    else:
        return "OPENCODE"  # 默认
```

#### Step 2.3: 进程管理
- 异步执行 Agent CLI
- 超时控制
- 输出捕获

---

## Workflow 3: P3 - Soul 注入 (0.5天)

### 任务清单
- [ ] 创建 `orchestrator/soul_injector.py` - Soul 注入
- [ ] 读取 soul files
- [ ] 拼接 system prompt
- [ ] BMAD 技能扩展集成

### 实施步骤

#### Step 3.1: Soul 注入器
```python
# src/ai_as_me/orchestrator/soul_injector.py
class SoulInjector:
    def __init__(self, soul_dir: Path)
    def load_soul() -> SoulContext
    def inject_bmad_skill(task: Task) -> Optional[str]
    def build_system_prompt(soul: SoulContext, bmad_skill: str) -> str
```

#### Step 3.2: BMAD 技能匹配
```python
# src/ai_as_me/orchestrator/skill_matcher.py
class SkillMatcher:
    def __init__(self, agent_manifest_path: Path)
    def find_skill_agent(task_type: str) -> Optional[str]
    def load_agent_persona(agent_name: str) -> str
```

#### Step 3.3: Prompt 拼接
```
System Prompt = Soul Context + BMAD Skill (if needed) + Task Context
```

---

## Workflow 4: P4 - 养蛊循环 (1天)

### 任务清单
- [ ] 创建 `yangu/reflector.py` - 反思引擎
- [ ] 创建 `yangu/rule_extractor.py` - 规则提取
- [ ] 执行结果解析
- [ ] 自动更新 rules.md

### 实施步骤

#### Step 4.1: 反思引擎
```python
# src/ai_as_me/yangu/reflector.py
class Reflector:
    def __init__(self, llm_client)
    def analyze_execution(result: ExecutionResult) -> ReflectionAnalysis
    def generate_reflection_prompt(result: ExecutionResult) -> str
```

#### Step 4.2: 规则提取器
```python
# src/ai_as_me/yangu/rule_extractor.py
class RuleExtractor:
    def __init__(self, rules_file: Path)
    def extract_rules(analysis: ReflectionAnalysis) -> List[Rule]
    def update_rules_file(rules: List[Rule]) -> None
```

#### Step 4.3: 养蛊循环
```
执行完成 → 反思分析 → 规则提取 → 更新 Soul → 经验入库
```

---

## Workflow 5: P5 - Agentic RAG (1天)

### 任务清单
- [ ] 创建 `rag/vectorstore.py` - 向量存储
- [ ] 创建 `rag/retriever.py` - 经验检索
- [ ] 执行历史向量化
- [ ] 相似任务检索

### 实施步骤

#### Step 5.1: 向量存储
```python
# src/ai_as_me/rag/vectorstore.py
class VectorStore:
    def __init__(self, db_path: str)
    def add_execution(execution: ExecutionResult) -> None
    def search_similar(query: str, top_k: int = 5) -> List[ExecutionResult]
```

#### Step 5.2: 经验检索器
```python
# src/ai_as_me/rag/retriever.py
class ExperienceRetriever:
    def __init__(self, vectorstore: VectorStore)
    def retrieve_similar_tasks(task: Task) -> List[ExecutionResult]
    def enhance_context(task: Task, experiences: List[ExecutionResult]) -> str
```

#### Step 5.3: RAG 集成
```
新任务 → 向量检索 → 相似经验 → 上下文增强 → Agent 执行
```

---

## Workflow 6: P6 - Dashboard 升级 (0.5天)

### 任务清单
- [ ] 任务创建表单
- [ ] Agent 执行状态展示
- [ ] 实时日志查看
- [ ] Soul files 在线编辑

### 实施步骤

#### Step 6.1: 任务创建表单
```html
<!-- 新增到 dashboard.py 模板 -->
<form id="create-task-form">
  <input name="title" placeholder="任务标题" required>
  <textarea name="description" placeholder="任务描述"></textarea>
  <select name="priority">
    <option value="normal">普通</option>
    <option value="high">高优先级</option>
  </select>
  <button type="submit">创建任务</button>
</form>
```

#### Step 6.2: 实时状态
```python
# 扩展现有 dashboard.py
@app.get("/api/agent/status")
async def get_agent_status():
    return {"status": "running", "current_task": "xxx"}

@app.get("/api/logs/stream")
async def stream_logs():
    # SSE 推送执行日志
```

#### Step 6.3: Soul 编辑器
```html
<div id="soul-editor">
  <textarea id="profile-editor">{{profile_content}}</textarea>
  <textarea id="mission-editor">{{mission_content}}</textarea>
  <textarea id="rules-editor">{{rules_content}}</textarea>
</div>
```

---

## CLI 命令实现

### 任务清单
- [ ] `ai-as-me task add` - 创建任务
- [ ] `ai-as-me task list` - 列出任务
- [ ] `ai-as-me serve` - 启动 Web Dashboard
- [ ] `ai-as-me agent start` - 启动 Agent 主循环

### 实施步骤

#### CLI 命令结构
```python
# src/ai_as_me/cli/main.py
@click.group()
def cli():
    pass

@cli.group()
def task():
    pass

@task.command()
@click.argument('description')
def add(description):
    """添加新任务"""

@task.command()
def list():
    """列出所有任务"""

@cli.command()
def serve():
    """启动 Web Dashboard"""

@cli.group()
def agent():
    pass

@agent.command()
def start():
    """启动 Agent 主循环"""
```

---

## 实施顺序

| 天数 | Workflow | 输出 |
|------|----------|------|
| 0.5天 | P1 Agent CLI 集成 | Agent 调用能力 |
| 0.5天 | P2 任务调度器 | 自动任务执行 |
| 0.5天 | P3 Soul 注入 | 个性化 Agent |
| 1天 | P4 养蛊循环 | 自我进化能力 |
| 1天 | P5 Agentic RAG | 经验复用 |
| 0.5天 | P6 Dashboard 升级 | 完整 Web 界面 |

**总计：4天完成 v2.0**
