# AI-as-Me v2.0 迭代方案

## 核心理念

**不造轮子，只做编排。** AI-as-Me 不实现 AI coding 能力，而是调度现有成熟的 Agent CLI 工具。

## 核心 Workflows

### Workflow 1: 任务执行流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Inbox   │───▶│   Todo   │───▶│  Doing   │───▶│   Done   │
│ 任务入口  │    │ 待执行    │    │ 执行中    │    │ 已完成    │
└──────────┘    └────┬─────┘    └────┬─────┘    └──────────┘
                     │               │
                     ▼               ▼
               ┌──────────┐    ┌──────────┐
               │ 能力评估  │    │ Agent CLI│
               │ 是否足够? │    │ 执行任务  │
               └────┬─────┘    └──────────┘
                    │
          ┌───Yes───┴───No───┐
          ▼                  ▼
    ┌──────────┐      ┌──────────┐
    │ Soul注入  │      │BMAD技能  │
    │ 直接执行  │      │扩展加载   │
    └──────────┘      └──────────┘
```

### Workflow 2: 养蛊循环

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 执行结果  │───▶│ 反思分析  │───▶│ 规则提取  │───▶│ Soul更新  │
│ 收集     │    │ 成功/失败 │    │ 经验总结  │    │ rules.md │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │                                               │
     │              ┌────────────────────────────────┘
     │              ▼
     │        ┌──────────┐
     └───────▶│ 向量存储  │◀─── 下次任务时检索相似经验
              │ 经验入库  │
              └──────────┘
```

### Workflow 3: Agent 选择与降级

```
┌──────────┐    ┌──────────────────────────────────┐
│ 任务类型  │───▶│           Agent 路由              │
│ 分析     │    │                                  │
└──────────┘    │  代码任务 ──▶ Claude Code        │
                │  通用任务 ──▶ OpenCode           │
                │  推理任务 ──▶ Gemini CLI         │
                │  中文任务 ──▶ Qwen Code          │
                └──────────────────────────────────┘
                             │
                             ▼
                ┌──────────────────────────────────┐
                │         失败降级策略              │
                │  主Agent失败 → 备选Agent重试      │
                │  3次失败 → 标记任务失败           │
                └──────────────────────────────────┘
```

### Workflow 4: Agentic RAG

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 新任务    │───▶│ 向量检索  │───▶│ 相似经验  │───▶│ 上下文    │
│ 进入     │    │ 历史任务  │    │ Top-K    │    │ 增强     │
└──────────┘    └──────────┘    └──────────┘    └────┬─────┘
                                                     │
                                                     ▼
                                               ┌──────────┐
                                               │ Soul +   │
                                               │ 经验 +   │
                                               │ BMAD技能 │
                                               │ = Prompt │
                                               └──────────┘
```

### 简化版完整流程

```
用户提交任务
     │
     ▼
┌─────────┐   能力不足   ┌─────────┐
│ Soul评估 │────────────▶│BMAD扩展 │
└────┬────┘             └────┬────┘
     │ 能力足够              │
     ▼                      ▼
┌─────────┐           ┌─────────┐
│ RAG检索 │◀──────────│合并Prompt│
│ 相似经验 │           └─────────┘
└────┬────┘
     │
     ▼
┌─────────┐   失败重试   ┌─────────┐
│Agent CLI│─────────────▶│备选Agent│
│  执行   │             └─────────┘
└────┬────┘
     │ 成功
     ▼
┌─────────┐
│ 养蛊反思 │──▶ 更新 rules.md + 经验入库
└─────────┘
```

---

## 架构设计

```
┌─────────────────────────────────────────────────────┐
│                   AI-as-Me (调度层)                  │
│  ┌───────────┐  ┌───────────┐  ┌───────────────┐   │
│  │ Soul 管理  │  │ 任务调度   │  │ Agent 编排    │   │
│  └───────────┘  └───────────┘  └───────────────┘   │
└─────────────────────┬───────────────────────────────┘
                      │ 注入 soul prompt
                      ▼
┌─────────────────────────────────────────────────────┐
│                外部 Agent CLI (执行层)               │
│  npx opencode-ai | claude-code | gemini-cli | ...  │
└─────────────────────┬───────────────────────────────┘
                      │ 执行结果
                      ▼
┌─────────────────────────────────────────────────────┐
│               Agentic RAG (反思层)                   │
│  ┌───────────┐  ┌───────────┐  ┌───────────────┐   │
│  │ 经验检索   │  │ 规则提取   │  │ Soul 更新     │   │
│  └───────────┘  └───────────┘  └───────────────┘   │
└─────────────────────────────────────────────────────┘
```

## 可用 Agent CLI

| Agent | 命令 | 特点 |
|-------|------|------|
| OpenCode | `npx -y opencode-ai@1.1.3` | HTTP API + SSE，支持 session fork |
| Claude Code | `npx -y @anthropic-ai/claude-code@2.0.76` | Anthropic 官方 |
| Gemini CLI | `npx -y @google/gemini-cli@0.22.5` | Google 官方 |
| Codex | `npx -y @openai/codex@0.77.0` | OpenAI 官方 |
| Qwen Code | `npx -y @qwen-code/qwen-code@0.2.1` | 阿里通义 |
| Cursor Agent | IDE 集成 | 需要 Cursor 环境 |
| Copilot | GitHub Copilot CLI | 需要 GitHub 账号 |
| Droid | 多模型支持 | GLM、Claude、GPT |
| AMP | Sourcegraph | 企业级 |

## Agent Profiles 配置

参考 vibe-kanban，每个 Agent 支持多种配置预设：

```json
// config/agent_profiles.json
{
  "CLAUDE_CODE": {
    "DEFAULT": { "dangerously_skip_permissions": true },
    "PLAN": { "plan": true },
    "OPUS": { "model": "opus" },
    "APPROVALS": { "approvals": true }
  },
  "OPENCODE": {
    "DEFAULT": { "auto_approve": true },
    "PLAN": { "mode": "plan", "auto_approve": true },
    "APPROVALS": { "auto_approve": false }
  },
  "GEMINI": {
    "DEFAULT": { "yolo": true },
    "FLASH": { "model": "gemini-3-flash-preview", "yolo": true },
    "PRO": { "model": "gemini-3-pro-preview", "yolo": true }
  },
  "QWEN_CODE": {
    "DEFAULT": { "yolo": true },
    "APPROVALS": { "yolo": false }
  }
}
```

## 任务动作类型

| 类型 | 说明 | 使用场景 |
|------|------|----------|
| `initial` | 首次执行 | 新任务 |
| `follow_up` | 追加执行 | 任务未完成，继续 |
| `review` | 代码评审 | 执行完成后审查 |
| `script` | 脚本执行 | 非 AI 任务 |

## 已完成模块

| 模块 | 文件 | 状态 |
|------|------|------|
| Kanban 数据库 | `kanban/database.py` | ✅ SQLite + Task/Execution/Rules 模型 |
| Kanban Dashboard | `kanban/dashboard.py` | ✅ FastAPI + SSE + 5列看板 + 拖拽 |
| Web 搜索工具 | `tools/web.py` | ✅ DuckDuckGo |
| Git 安全网 | `tools/git_safety.py` | ✅ 备份/回滚 |
| Soul 文件 | `soul/*.md` | ✅ profile/mission/rules 已填充 |

## 迭代计划

### P1: Agent CLI 集成 (0.5天)
- [ ] 封装 Agent 调用接口（spawn + 输出捕获）
- [ ] 支持 OpenCode HTTP API 模式
- [ ] Agent 健康检查

### P2: 任务调度器 (0.5天)
- [ ] 从 kanban 读取待执行任务
- [ ] 根据任务类型选择 Agent
- [ ] 进程生命周期管理

### P3: Soul 注入 (0.5天)
- [ ] 读取 soul files (profile/mission/rules)
- [ ] 拼接为 system prompt
- [ ] 注入到 Agent 启动参数

### P4: 养蛊循环 (1天)
- [ ] 执行结果解析
- [ ] 反思 prompt 生成
- [ ] 规则提取（成功/失败经验）
- [ ] 自动更新 rules.md

### P5: Agentic RAG (1天)
- [ ] 执行历史向量化存储
- [ ] 相似任务经验检索
- [ ] 上下文增强决策

### P6: Dashboard 升级 (0.5天)
- [ ] Agent 执行状态实时展示
- [ ] Soul files 在线编辑
- [ ] 养蛊循环可视化

## 总工期：4天

## 任务提交入口

### 支持的提交方式

| 方式 | 优先级 | 说明 |
|------|--------|------|
| **CLI** | P1 | `ai-as-me task add "任务描述"` |
| **Web Dashboard** | P1 | 表单提交，拖拽管理 |
| **文件系统** | P1 | 直接放入 `kanban/inbox/*.md` |
| **REST API** | P2 | `POST /api/tasks` |
| **监控目录** | P2 | 监控指定目录的文件变化自动创建任务 |

### CLI 命令设计

```bash
# 添加任务
ai-as-me task add "实现用户登录功能"
ai-as-me task add -f task.md              # 从文件创建

# 查看任务
ai-as-me task list                         # 列出所有任务
ai-as-me task list --status todo           # 按状态筛选

# 管理任务
ai-as-me task move <id> doing              # 移动任务
ai-as-me task approve <id>                 # 审批任务

# 启动服务
ai-as-me serve                             # 启动 Web Dashboard
ai-as-me agent start                       # 启动 Agent 主循环
```

### REST API 设计

```
POST   /api/tasks          # 创建任务
GET    /api/tasks          # 列出任务
GET    /api/tasks/:id      # 获取任务详情
PATCH  /api/tasks/:id      # 更新任务状态
DELETE /api/tasks/:id      # 删除任务

GET    /api/executions     # 执行历史
GET    /api/soul           # 获取 Soul 文件
PUT    /api/soul/:file     # 更新 Soul 文件

GET    /api/agents/status  # Agent 运行状态
POST   /api/agents/start   # 启动 Agent
POST   /api/agents/stop    # 停止 Agent
```

---

## vibe-kanban 集成策略

### 决策：不直接集成，只复用思路

| 对比项 | vibe-kanban | AI-as-Me Dashboard |
|--------|-------------|-------------------|
| 技术栈 | Rust + React | Python + FastAPI |
| 部署复杂度 | 高（需编译 Rust） | 低（pip install） |
| 功能完整度 | 高 | 中等 |
| 与 Soul/养蛊 集成 | 需要适配 | 原生支持 |

### 从 vibe-kanban 复用的内容

1. **Agent CLI 调用方式** - npx 直接调用，不重新实现
2. **任务状态模型** - inbox/todo/doing/done/blocked
3. **SSE 实时更新** - 前端实时刷新执行状态
4. **多 Agent 支持** - 可配置多个执行器

### 不复用的内容

1. **Rust 后端** - 用 Python 重写核心逻辑
2. **React 前端** - 用简单 HTML + HTMX 或保持现有 FastAPI 模板
3. **数据库** - 用 SQLite 而非 PostgreSQL

---

## Web Dashboard 演进路线

### 技术选型

**FastAPI + HTMX**（轻量，Python 统一栈，交互性好）

### 版本规划

```
v2.0 (当前)              v2.1                    v2.2
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│ 看板拖拽     │      │ + Soul编辑  │      │ + 多用户    │
│ 任务创建     │ ───▶ │ + 执行日志  │ ───▶ │ + 权限管理  │
│ SSE实时更新  │      │ + 养蛊图表  │      │ + 移动端    │
└─────────────┘      └─────────────┘      └─────────────┘
```

### 功能矩阵

| 功能 | v2.0 | v2.1 | v2.2 |
|------|------|------|------|
| 看板视图（5列拖拽） | ✅ | ✅ | ✅ |
| 任务创建表单 | ✅ | ✅ | ✅ |
| SSE 实时状态 | ✅ | ✅ | ✅ |
| Soul 在线编辑 | ❌ | ✅ | ✅ |
| 执行日志查看 | ❌ | ✅ | ✅ |
| 养蛊数据可视化 | ❌ | ✅ | ✅ |
| Agent 控制台 | ❌ | ✅ | ✅ |
| 多用户支持 | ❌ | ❌ | ✅ |
| 权限管理 | ❌ | ❌ | ✅ |
| 移动端适配 | ❌ | ❌ | ✅ |

## 文件结构

```
src/ai_as_me/
├── orchestrator/
│   ├── agent_cli.py      # Agent CLI 封装
│   ├── scheduler.py      # 任务调度
│   └── soul_injector.py  # Soul 注入
├── yangu/                 # 养蛊模块
│   ├── reflector.py      # 反思引擎
│   └── rule_extractor.py # 规则提取
├── rag/
│   ├── vectorstore.py    # 向量存储
│   └── retriever.py      # 经验检索
└── kanban/
    ├── database.py       # 已有
    └── dashboard.py      # 已有，待升级
```

## 补充项（评审后新增）

### vibe-kanban 参考遗漏项（已补充）

| 优先级 | 遗漏项 | 状态 |
|--------|--------|------|
| P1 | Agent Profiles 配置 | ✅ 已加入 |
| P1 | 任务动作类型 | ✅ 已加入 |
| P2 | 审批策略配置化 | 待实现 |
| P2 | 更多 Agent 支持（Cursor/Copilot/Droid） | ✅ 已列出 |
| P3 | MCP 集成 | v2.1 考虑 |

### 错误处理策略
- 重试机制：失败后重试 3 次，指数退避
- 降级策略：主 Agent 失败 → 切换备选 Agent
- 熔断保护：连续失败 5 次暂停该 Agent

### 并发模型
- v2.0 采用串行队列，单任务执行
- v2.1 支持并发池（可配置 worker 数量）

### 成功指标
- 任务成功率 = 完成任务数 / 总任务数
- 规则增长率 = 新增规则数 / 反思次数
- 经验复用率 = RAG 命中次数 / 总查询次数

### 配置管理
- 统一 `.env` 管理所有 API Key
- 支持环境变量覆盖

### 日志聚合
- 所有 Agent 输出写入 `logs/executions/`
- Dashboard 实时展示执行日志

### 测试策略
- Mock Agent CLI 输出进行单元测试
- 规则变更前后对比测试

---

## BMAD 技能扩展

### 设计理念
当 Soul 能力不足以执行任务时，动态加载 BMAD agents 作为"技能扩展包"。

### 技能映射表

| 任务类型 | 缺失能力 | BMAD Agent | 文件路径 |
|----------|----------|------------|----------|
| 需求分析 | 业务分析 | Mary (Analyst) | `_bmad/bmm/agents/analyst.md` |
| 系统设计 | 架构能力 | Winston (Architect) | `_bmad/bmm/agents/architect.md` |
| 代码实现 | 开发能力 | Amelia (Dev) | `_bmad/bmm/agents/dev.md` |
| 技术文档 | 写作能力 | Paige (Tech Writer) | `_bmad/bmm/agents/tech-writer.md` |
| 测试策略 | QA 能力 | Murat (TEA) | `_bmad/bmm/agents/tea.md` |
| 用户体验 | UX 设计 | Sally (UX Designer) | `_bmad/bmm/agents/ux-designer.md` |
| 创意激发 | 创新思维 | Carson (Brainstorming) | `_bmad/cis/agents/brainstorming-coach.md` |
| 问题解决 | 系统思维 | Dr. Quinn | `_bmad/cis/agents/creative-problem-solver.md` |

### 加载流程

```
任务进入 → 能力评估 → Soul 能力足够? 
                         ├─ Yes → 直接执行
                         └─ No  → 查询 agent-manifest.csv
                                  → 加载匹配 Agent 的 persona + principles
                                  → 合并到 Soul prompt
                                  → 执行任务
```

### 文件结构新增

```
src/ai_as_me/
├── orchestrator/
│   ├── agent_cli.py
│   ├── scheduler.py
│   ├── soul_injector.py
│   └── skill_matcher.py   # 新增：BMAD 技能匹配器
```

### 实现要点

1. **能力评估** - 分析任务描述，提取所需技能关键词
2. **Agent 匹配** - 从 `_bmad/_config/agent-manifest.csv` 查找最匹配的 agent
3. **Persona 注入** - 提取 agent 的 role/identity/principles，合并到 soul prompt
4. **临时 vs 永久** - 技能扩展默认临时生效，用户可选择永久写入 soul

---

## 设计原则

1. **最小实现** - 只写必要代码，能用现成的就不造
2. **松耦合** - Agent 可替换，不绑定特定实现
3. **养蛊优先** - 核心价值是自我进化，不是任务执行
4. **经验复用** - 通过 RAG 让每次执行都能借鉴历史
5. **技能可扩展** - 通过 BMAD agents 动态补充能力
